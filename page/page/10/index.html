
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>Matt Aimonetti</title>
    <meta name="author" content="Matt Aimonetti">

    
    <meta name="description" content="MacRuby Tips: How to Play an Audio File Let&#8217;s say you would like to play an audio file in your MacRuby app/script, how would you do?
It&#8217; &hellip;">
    
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />

    <link href="/Matt-Aimonetti/atom.xml" rel="alternate" title="Matt Aimonetti" type="application/atom+xml">
    <link rel="canonical" href="http://mattetti.github.com/Matt-Aimonetti">
    <link href="/Matt-Aimonetti/favicon.png" rel="shortcut icon">
    <link href="/Matt-Aimonetti/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30927742-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
	<header><div id='meta' class='inner'>
  <div id="matt-aimonetti" itemscope itemtype="http://data-vocabulary.org/Person">
    <img class="photo left" src="/Matt-Aimonetti/images/matt_aimonetti.jpg" />
    <h1 class="left"><a itemprop="name" href="/Matt-Aimonetti/">Matt Aimonetti</a></h1>
    <br>
    <ul class='left'>
      <li><a href='http://www.linkedin.com/in/mattaimonetti'>Software Architecture</a> at <span itemprop="affiliation">LivingSocial</span></li>
      <li><a href='http://www.oreillynet.com/pub/au/4385'>Author</a> at <span itemprop="affiliation">O'Reilly</span></li>
      <li>Open-source <a href="/articles/archives">evangelist</a></li>
      <li><a href="https://github.com/mattetti">Web engineer</a></li>
    </ul>
  <nav class="menu left"><ul class="main">
	<li><a href="/Matt-Aimonetti/">Articles</a></li>
	<li><a href="/Matt-Aimonetti/posts/archives">Archives</a></li>
</ul>
</nav>
  <div class="right">
    <form class="search right" action="http://google.com/search" method="get">
      <input class="left" type="text" name="q" results="0">
      <input type="hidden" name="q" value="site:mattetti.github.com/Matt-Aimonetti">
    </form>
    <div class="social right">
      
      
      <a class="google" rel='me' href="https://plus.google.com/101114877505962271216?rel=author" title="Google+">Google+</a>
      
      
      <a class="twitter" rel='me' href="http://twitter.com/merbist" title="Twitter">Twitter</a>
      
      
      <a class="github" rel='me' href="https://github.com/mattetti" title="GitHub">GitHub</a>
      
      
      
      <a class="linkedin" rel='me' href="http://www.linkedin.com/in/mattaimonetti" title="Linkedin">Linkedin</a>
      
      
      <a class="rss" rel='me' href="/Matt-Aimonetti/atom.xml" title="RSS">RSS</a>
      
    </div>
  </div>
</div>

</header>
	
<!--
<div id="banner" class="inner">
	<div class="container">
		<ul class="feed"></ul>
	</div>
	<small><a href="http://twitter.com/merbist">merbist</a> @ <a href="http://twitter.com">Twitter</a></small>
	<div class="loading">Loading...</div>
</div>
<script src="/Matt-Aimonetti/javascripts/twitter.js"></script>
<script type="text/javascript">
	(function($){
		$('#banner').getTwitterFeed('merbist', 0, false);
	})(jQuery);
</script>
-->


	<div id="content" class="inner">


    <article class="post">
    <h1 class="title entry-title"><a href="/Matt-Aimonetti/posts/2009/10/06/macruby-tips-how-to-play-an-audio-file/">MacRuby Tips: How to Play an Audio File</a></h1>
    <div class="entry">
        <p>Let&#8217;s say you would like to play an audio file in your MacRuby app/script, how would you do?
It&#8217;s actually pretty simple, you just need to use NSSound. If we wanted to use a system sound we could do:</p>

<pre><code>NSSound.soundNamed('Basso').play
</code></pre>

<p>But let&#8217;s look at a more advanced example with some Cocoa patterns. We will loop through all the audio files in a folder and we will play them one after the other.</p>

<pre><code>#!/usr/bin/env macruby
framework 'Cocoa'
# Cocoa documentation reference:
# http://developer.apple.com/mac/library/documentation/Cocoa/Reference/ApplicationKit/Classes/NSSound_Class/Reference/Reference.html

def play_sound
  if @sounds.empty?
    NSApplication.sharedApplication.terminate(nil)
  else
    sound_file = @sounds.shift
    s = NSSound.alloc.initWithContentsOfFile(sound_file, byReference: false)
    puts "previewing #{sound_file}"
    s.delegate = self
    s.play
  end
end

# This is a delegate method called by the sound object
def sound(sound, didFinishPlaying: state)
  play_sound if state
end

# Delegate method called when the app finished loading
def applicationDidFinishLaunching(notification)
  @sounds = Dir.glob("/System/Library/Sounds/*.aiff")
  play_sound
end

# We are delegating the application to self so the script will know when
# it finished loading
NSApplication.sharedApplication.delegate = self
NSApplication.sharedApplication.run
</code></pre>

<p>On my machine, I get the following output:</p>

<pre><code>$ macruby macrubysound.rb
previewing /System/Library/Sounds/Basso.aiff
previewing /System/Library/Sounds/Blow.aiff
previewing /System/Library/Sounds/Bottle.aiff
previewing /System/Library/Sounds/Frog.aiff
previewing /System/Library/Sounds/Funk.aiff
previewing /System/Library/Sounds/Glass.aiff
previewing /System/Library/Sounds/Hero.aiff
previewing /System/Library/Sounds/Morse.aiff
previewing /System/Library/Sounds/Ping.aiff
previewing /System/Library/Sounds/Pop.aiff
previewing /System/Library/Sounds/Purr.aiff
previewing /System/Library/Sounds/Sosumi.aiff
previewing /System/Library/Sounds/Submarine.aiff
previewing /System/Library/Sounds/Tink.aiff
</code></pre>

<p>Cocoa delegation might seem a bit strange at first when you come from Ruby. In Ruby we rarely do any type of async delegation so let&#8217;s quickly look at what&#8217;s going on in this script.</p>

<p>The first thing we do is loading the cocoa framework which makes total sense, then we define a bunch of methods and finally we get to:</p>

<pre><code>NSApplication.sharedApplication.delegate = self
NSApplication.sharedApplication.run
</code></pre>

<p>We are setting the run loop to delegate to set, which means that when an event is triggered, the delegation method will be called on self (our script).
Once that done, we are starting out run loop.</p>

<p>Once the application is loaded the applicationDidFinishLaunching delegate is being triggered (line 24). At this point, we are looking for all the sound files in the sound system folder and storing them in an instance variable (line 25). Finally, we are calling the play_sound method (line 26).</p>

<p>The play_sound method checks that we have some audio files left to play (line 7), otherwise it quits the app. (line 8 ) If we still have some files in the queue, we get the first one (line 10) and use it to create an instance of NSSound (line 11).</p>

<p>Before playing the NSSound instance, we are setting its delegate to our script (self) (line 13). If you read <a href="http://developer.apple.com/mac/library/documentation/Cocoa/Reference/ApplicationKit/Classes/NSSound_Class/Reference/Reference.html">NSSound Cocoa documentation</a> for #play, you will notice that #play &#8220;initiates playback asynchronously and returns control to your application. Therefore, your application can continue doing work while the audio is playing.&#8221; In our case, we don&#8217;t want to do that, otherwise all the sounds will play at the same time.</p>

<p>The documentation also mentions a delegation you can use to avoid that. This is exactly what we did when we implemented:  def sound(sound, didFinishPlaying: state) (line 19)</p>

<p>Rubyists might be surprised by the method signature. MacRuby extended Ruby to support Objective-C selectors.</p>

<p>When the sound is playing, this delegate gets called, we check on the state of the sound, if it finished playing then we call play_sound again.</p>

<p>That&#8217;s it!  It&#8217;s a very elegant implementation giving us the benefits of both Ruby and Cocoa.</p>

        
        
    </div>
    <div class="meta">
        <div class="date updated">








  


<time datetime="2009-10-06T19:00:08+02:00" pubdate data-updated="true">Oct 6<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/Matt-Aimonetti/articles/categories/macruby/'>macruby</a>
  
</div>

</div>
        <div class='vcard author'><small>By <span class='fn'>Matt Aimonetti</span></small></div>
        
    </div>

</article>


    <article class="post">
    <h1 class="title entry-title"><a href="/Matt-Aimonetti/posts/2009/10/06/macruby-tips-embed-a-custom-font/">MacRuby Tips: Embed a Custom Font</a></h1>
    <div class="entry">
        <p>Let say you want to release your MacRuby app and use a custom embedded font?
You probably don&#8217;t want to force your users to install the font.
Well, don&#8217;t worry, just put the font file in your resources folder and use the following code:</p>

<pre><code>font_location = NSBundle.mainBundle.pathForResource('MyCustomFont', ofType: 'ttf')
font_url = NSURL.fileURLWithPath(font_location)
# in MacRuby, always make sure that cocoa constants start by an uppercase
CTFontManagerRegisterFontsForURL(font_url, KCTFontManagerScopeProcess, nil)
</code></pre>

<p>That&#8217;s it, now your custom font is available and you can change your textfield instance&#8217;s font like that:</p>

<pre><code>text_field.font = NSFont.fontWithName('MyCustomFont', size:24)
</code></pre>

<p>The only tricky things here were to know the Cocoa API call and to know that even if the Cocoa API references the constant to use as kCTFontManagerScopeProcess, because in Ruby, constants start by an uppercase, you need to convert it to: KCTFontManagerScopeProcess.</p>

        
        
    </div>
    <div class="meta">
        <div class="date updated">








  


<time datetime="2009-10-06T09:23:44+02:00" pubdate data-updated="true">Oct 6<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/Matt-Aimonetti/articles/categories/macruby/'>macruby</a>
  
</div>

</div>
        <div class='vcard author'><small>By <span class='fn'>Matt Aimonetti</span></small></div>
        
    </div>

</article>


    <article class="post">
    <h1 class="title entry-title"><a href="/Matt-Aimonetti/posts/2009/10/05/macruby-soon-to-reach-a-new-milestone/">MacRuby Soon to Reach a New Milestone</a></h1>
    <div class="entry">
        <p>Laurent just posted a <a href="http://bit.ly/2YPwRT">MacRuby status update</a> on the mailing list and the first official beta of MacRuby 0.5 should be released pretty soon.</p>

<p>Let&#8217;s quickly look at Laurent&#8217;s report:</p>

<ul>
<li><p>Early backtracing support.</p></li>
<li><p>Much better AOT compilation. Parts of the standard library are now pre-compiled for testing.</p></li>
<li><p>Migrated to LLVM top of tree.</p></li>
<li><p>Dispatcher performance is now back to normal (we lost about 30% due to gcc not inlining code).</p></li>
<li><p>Many bug fixes.</p></li>
</ul>


<p>In lay terms, backtracing is what you see when your app crashes or has a problem, it&#8217;s the list of methods called before the exception was raised and the line where the error happened. Currently the backtrace is similar to what you would have with Ruby 1.9, however objective-c exceptions are not supported and there is still some work to do.</p>

<p>AOT compilation or Ahead Of Time compilation is the process of compiling a script into machine code. I already covered that <a href="http://merbist.com/2009/07/12/compiled-hello-world-with-macruby/">feature earlier</a>. Progress has been made and now some Ruby standard libraries are now pre-compiled in MacRuby. The two main advantages of doing AOT compilation are startup speed and obfuscation. Two important features for desktop applications or for when you want to license your server app.</p>

<p>Updating LLVM doesn&#8217;t mean much for end users. With the support of the MacRuby team, <a href="http://www.icoretech.org/">Claudio</a> setup a nightly build bot <a href="http://macruby.icoretech.org/">http://macruby.icoretech.org/</a> allowing you to download nightly builds for SnowLeopard. The app is a <a href="http://sinatrarb.com">Sinatra app</a> that could can checkout on github:  <a href="http://github.com/masterkain/macruby-nightlies-web">http://github.com/masterkain/macruby-nightlies-web</a> What&#8217;s interesting is that Apple is sponsoring both LLVM and MacRuby which will hopefully bring some synergy and help both projects.</p>

<p>Fixed dispatcher, this is a just a perf bug fix only affecting people on trunk.</p>

<p>I personally used MacRuby quite a lot recently. I have been writing a 2D video game for my <a href="http://rubyconf.org/talks/153-writing-2-d-games-for-the-osx-platform-in-ruby">RubyConf talk</a>.</p>

<p><img src="http://img.skitch.com/20091006-kj64ix4up5q8dh4yin38hjrjcp.jpg" alt="" />It&#8217;s a simple game only using Ruby and Cocoa. It&#8217;s not a fancy game and, no, it doesn&#8217;t run on the iPhone yet ;)</p>

<p>I never wrote a game in Cocoa and I decided not to use an existing framework like Gosu or cocos2d, instead I decided to write everything from scratch. Using CoreAnimation instead of OpenGL, the task wasn&#8217;t that hard at all. in less than 1,000 LOC (before refactoring), I have a fully working game.</p>

<p>I will be previewing the game at <a href="http://www.railssummit.com.br/">RailsSummit</a> and will show the code and explain how to get there at <a href="http://rubyconf.org/talks/153-writing-2-d-games-for-the-osx-platform-in-ruby">RubyConf</a>.</p>

<p>When I started getting involved with MacRuby, I really did not think I would write a video game in Ruby and actually enjoy it. At the end of the day, I will more than likely use MacRuby for desktop/mobile/server apps more than games, but it&#8217;s awesome to be able to use your favorite language to do other things than what you are usually paid to do.</p>

<p>MacRuby is coming along very nicely, and I&#8217;m really excited about the multitude of new options offered to Ruby developers on OSX and can&#8217;t wait for 0.5 final and see what people will do with it.</p>

        
        
    </div>
    <div class="meta">
        <div class="date updated">








  


<time datetime="2009-10-05T23:58:53+02:00" pubdate data-updated="true">Oct 5<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/Matt-Aimonetti/articles/categories/macruby/'>macruby</a>
  
</div>

</div>
        <div class='vcard author'><small>By <span class='fn'>Matt Aimonetti</span></small></div>
        
    </div>

</article>


    <article class="post">
    <h1 class="title entry-title"><a href="/Matt-Aimonetti/posts/2009/08/30/blog-status/">Blog Status</a></h1>
    <div class="entry">
        <p>I had people asking me how come I was not blogging as much lately. Well, on top of being really busy, I have been blogging on other blogs such as the <a href="http://weblog.rubyonrails.org/">official Rails blog</a>.</p>

<p>There aren&#8217;t a lot of Merb news, we are waiting for Carl and Yehuda to sign out on the 1.1 release and will hopefully soon start the migration work to Rails3. If you want more news about Rails3, check <a href="http://yehudakatz.com/">Yehuda&#8217;s blog</a> and the <a href="http://weblog.rubyonrails.com/">official Rails blog</a>. Lots of exciting things are coming up.</p>

<p>Finally, if you are planning on upgrading your Mac to Snow Leopard, <a href="http://weblog.rubyonrails.org/2009/8/30/upgrading-to-snow-leopard">these instructions</a> are also valid for all Ruby developers on an Intel mac.</p>

        
        
    </div>
    <div class="meta">
        <div class="date updated">








  


<time datetime="2009-08-30T16:35:01+02:00" pubdate data-updated="true">Aug 30<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/Matt-Aimonetti/articles/categories/misc/'>Misc</a>
  
</div>

</div>
        <div class='vcard author'><small>By <span class='fn'>Matt Aimonetti</span></small></div>
        
    </div>

</article>


    <article class="post">
    <h1 class="title entry-title"><a href="/Matt-Aimonetti/posts/2009/07/27/ruby-rack-and-couchdb-lots-of-awesomeness/">Ruby, Rack and CouchDB = Lots of Awesomeness</a></h1>
    <div class="entry">
        <p>Over the weekend, I spent some time working on a Ruby + Rack +CouchDB project. Three technologies that I know quite well but that I never put to work together at the same time, at least not directly.  Let&#8217;s call this Part I.</p>

<p>Before we get started, let me introduce each component:</p>

<ul>
<li><p><a href="http://en.wikipedia.org/wiki/Ruby%20%28programming%20language%29">Ruby</a> : if you are reading this blog, you more than likely know at least a little bit about, what I consider, one of the most enjoyable programming language out there. It&#8217;s also a very flexible language that lets us do some interesting things. I could have chosen Python to do the same project but that&#8217;s a whole different topic. For this project we will do something Ruby excels at: reopening existing classes and injecting more code.</p></li>
<li><p><a href="http://rack.rubyforge.org/">Rack</a>: a webserver interface written in Ruby and inspired by <a href="http://www.wsgi.org/wsgi/">Python&#8217;s WSGI</a>. Basically, it&#8217;s a defined API to interact between webservers and web frameworks. It&#8217;s used by most common Ruby web frameworks, from Sinatra to Rails (btw, Rails3 is going to be even more Rack-focused than it already is). So, very simply put, the webserver receives a request, passes it to Rack, that converts it, passes it to your web framework and the web framework sends a response in the expected format (more on Rack later).</p></li>
<li><p><a href="http://couchdb.apache.org/">CouchDB</a>: Apache&#8217;s document-oriented database. RESTful API, schema-less, written in Erlang with built-in support for map/reduce. For this project, I&#8217;m using <a href="http://github.com/mattetti/couchrest">CouchRest</a>, a Ruby wrapper for Couch.</p></li>
</ul>


<h2>Goal: Log Couch requests and analyze data</h2>

<p>Let&#8217;s say we have a Rails, Sinatra or Merb application and we are using CouchRest (maybe we are using CouchRest and ActiveRecord, but let&#8217;s ignore that for now).</p>

<p>Everything works fine but we would like to profile our app a little and maybe optimize the DB usage. The default framework loggers don&#8217;t support Couch. The easy way would be to tail the Couch logs or look at the logs in <a href="http://janl.github.com/couchdbx/">CouchDBX</a>. Now, while that works, we can&#8217;t really see what DB calls are made per action, so it makes any optimization work a bit tedious. (Note that Rails3 will have some better conventions for logging, making things even easier)</p>

<p>So, let&#8217;s see how to fix that. Let&#8217;s start by looking at Rack.</p>

<h2>Rack Middleware</h2>

<p>Instead of hacking a web framework specific solution, let&#8217;s use Rack. Rack is dead simple, you just need to write a class that has a <em>call</em> method.
In our case, we don&#8217;t care about modifying the response, we just want to instrument our app. We just want our middleware to be transparent and let our webserver deal with it normally.</p>

<p>Here we go &#8230; that wasn&#8217;t hard, was it? We keep the application reference in the @app variable when a new instance of the middleware is created. Then when the middleware is called, we just call the rest of the chain and pretend nothing happened.</p>

<p>As you can see, we just added some logging info around the request. Let&#8217;s do one better and save the logs in CouchDB:</p>

<p>Again, nothing complicated. In our rackup file we defined which Couch database to use and we passed it to our middleware (we change our initialize method signature to take the DB).
Finally, instead of printing out the logs, we are saving them to the database.</p>

<p>W00t! At this point all our requests have been saved in the DB with all the data there, ready to be manipulated by some map/reduce views we will write. For the record, you might want to use the bulk_save approach in CouchDB which will wait for X amount of records to save them in the DB all at once. Couch also let&#8217;s you send new documents, but only save it to the DB every X documents or X seconds.</p>

<p><img src="http://img.skitch.com/20090726-ebmpgjtrc6x8239ia69kmri1rt.jpg" alt="" /></p>

<p>As you can see, our document contains the timestamps and the full environment as a hash.</p>

<p>All of that is nice, but even though we get a lot of information, we could not actually see any of the DB calls made in each request. Let&#8217;s fix that and inject our logger in CouchRest (you could apply the same approach to any adapter).</p>

<p>Let&#8217;s reopen the HTTP Abstraction layer class used by CouchRest and inject some instrumentation:</p>

<p>Again, nothing fancy, we are just opening the module, reopening the methods and wrapping our code around the <em>super</em> call (for those who don&#8217;t know, <em>super</em> calls the original method).</p>

<p>This is all for Part I. In Part II, we&#8217;ll see how to process the logs and make all that data useful.</p>

<p>By the way, if you make it to <a href="http://www.railssummit.com.br/">RailsSummit</a>, I will be giving a talk on Rails3 and the new exciting stuff you will be able to do including Rack based stuff, CouchDB, MongoDB, new DataMapper etc..</p>

<p><a href="http://railssummit.com.br/"><img src="http://railssummit.com.br/images/banners/en_souPalestrante_210x60.jpg" alt="" /></a></p>

        
        
    </div>
    <div class="meta">
        <div class="date updated">








  


<time datetime="2009-07-27T13:49:20+02:00" pubdate data-updated="true">Jul 27<span>th</span>, 2009</time></div>
        <div class="tags">

<div class="cat">
  
    <a class='category' href='/Matt-Aimonetti/articles/categories/misc/'>Misc</a>, <a class='category' href='/Matt-Aimonetti/articles/categories/tutorial/'>Tutorial</a>, <a class='category' href='/Matt-Aimonetti/articles/categories/merb/'>merb</a>, <a class='category' href='/Matt-Aimonetti/articles/categories/rails/'>rails</a>, <a class='category' href='/Matt-Aimonetti/articles/categories/ruby/'>ruby</a>
  
</div>

</div>
        <div class='vcard author'><small>By <span class='fn'>Matt Aimonetti</span></small></div>
        
    </div>

</article>

<nav id="pagenavi">
    
        <a href="/Matt-Aimonetti/page/page/9/" class="prev">Prev</a>
    
    
        <a href="/Matt-Aimonetti/page/page/11/" class="next">Next</a>
    
    <a href="/Matt-Aimonetti/articles/archives" class="center">Archives</a>
</nav>
</div>
	<footer class="inner"><div id='copyright-notice'>Copyright &copy; 2012 Matt Aimonetti</div>
</footer>
	<script src="/Matt-Aimonetti/javascripts/jquery.fancybox.pack.js"></script>
<script src="/Matt-Aimonetti/javascripts/slash.js"></script>




</body>
</html>
